package com.cinema.dev.controllers;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import com.cinema.dev.forms.TicketForm;
import com.cinema.dev.models.Bloc;
import com.cinema.dev.models.Client;
import com.cinema.dev.models.Film;
import com.cinema.dev.models.Ticket;
import com.cinema.dev.repositories.BlocRepository;
import com.cinema.dev.repositories.CaisseRepository;
import com.cinema.dev.repositories.ClientRepository;
import com.cinema.dev.repositories.FilmRepository;
import com.cinema.dev.repositories.MouvementCaisseRepository;
import com.cinema.dev.repositories.PaiementRepository;
import com.cinema.dev.repositories.PlaceRepository;
import com.cinema.dev.repositories.TicketRepository;
import com.cinema.dev.views.TicketDetail;
import com.cinema.dev.views.TicketFiche;

import lombok.RequiredArgsConstructor;

import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;

@Controller
@RequestMapping("/tickets")
@RequiredArgsConstructor
public class ReservationController {

    private final BlocRepository blocRepository;
    private final ClientRepository clientRepository;
    private final FilmRepository filmRepository;
    private final TicketRepository ticketRepository;
    private final PlaceRepository placeRepository;
    private final PaiementRepository paiementRepository;
    private final MouvementCaisseRepository mouvementCaisseRepository;
    private final CaisseRepository caisseRepository;

    @GetMapping("/saisie")
    public String ticketSaisieForm(Model model) {
        model.addAttribute("content", "pages/tickets/ticket-saisie");

        model.addAttribute("ticketForm", new TicketForm());
        model.addAttribute("blocs", Bloc.getAll(blocRepository));
        model.addAttribute("clients", Client.getAll(clientRepository));
        model.addAttribute("films", Film.getAll(filmRepository));

        return "admin-layout";
    }

    @PostMapping("/saisie")
    public String ticketSaisie(RedirectAttributes rd, @ModelAttribute TicketForm ticketForm,
            @RequestParam(required = false) String numeroPlaceStr) {
        try {
            if (numeroPlaceStr != null && !numeroPlaceStr.isEmpty()) {
                List<Long> numeroPlaces = Arrays.stream(numeroPlaceStr.split(";"))
                        .map(String::trim)
                        .map(Long::parseLong)
                        .collect(Collectors.toList());
                ticketForm.setNumeroPlace(numeroPlaces);
            }
            List<Ticket> tickets = Ticket.initByForm(ticketForm, placeRepository, ticketRepository, clientRepository, filmRepository);
            Ticket.saveAll(tickets, ticketRepository);

            rd.addFlashAttribute("toastMessage", "Ticket enregistré avec succès !");
            rd.addFlashAttribute("toastType", "success");
        } catch (Exception e) {
            rd.addFlashAttribute("toastMessage", e.getMessage());
            rd.addFlashAttribute("toastType", "error");
            e.printStackTrace();
        }
        return "redirect:/tickets/saisie";
    }

    @GetMapping("/liste")
    public String ticketListe(Model model) {
        model.addAttribute("content", "pages/tickets/ticket-liste");
        System.out.println(LocalDateTime.now());
        List<Ticket> tickets = Ticket.getAll(ticketRepository);
        List<TicketDetail> ticketDetails = tickets.stream()
            .map(ticket -> TicketDetail.builder()
                .ticketStrId(ticket.getStrId())
                .blocStrId(ticket.getPlace().getBloc().getStrId())
                .salleStrId(ticket.getPlace().getSalle().getStrId())
                .numeroPlace(ticket.getPlace().getNumero())
                .clientStrId(ticket.getClient().getStrId())
                .codeGroupe(ticket.getCodeGroupe())
                .datePrevue(ticket.getDatePrevue())
                .prix(ticket.getPlace().getBloc().getPrix())
                .build())
            .collect(Collectors.toList());
        
        model.addAttribute("ticketDetails", ticketDetails);
        
        return "admin-layout";
    }

    @GetMapping("/fiche/{ticketStrId}")
    public String ticketFiche(@PathVariable String ticketStrId, Model model) {
        model.addAttribute("content", "pages/tickets/ticket-fiche");
        
        
        
        Ticket ticket = Ticket.findByStrId(ticketRepository, ticketStrId);
        if (ticket == null) {
            model.addAttribute("toastMessage", "Ticket non trouvé !");
            model.addAttribute("toastType", "error");
            return "redirect:/tickets/liste";
        }
        
        TicketFiche ticketFiche = ticket.toFiche(ticketRepository);
        
        model.addAttribute("ticketFiche", ticketFiche);
        model.addAttribute("caisses", caisseRepository.findAll());
        
        return "admin-layout";
    }

    @PostMapping("/payer/{ticketStrId}")
    public String payerTicket(@PathVariable String ticketStrId, 
                              @RequestParam String strIdCaisse,
                              @RequestParam Double montantTotal,
                              RedirectAttributes rd) {
        try {
            Ticket ticket = Ticket.findByStrId(ticketRepository, ticketStrId);
            if (ticket == null) {
                throw new Exception("Ticket non trouvé");
            }
            
            
            
            ticket.toutPayer(montantTotal, strIdCaisse, ticketRepository, paiementRepository  , mouvementCaisseRepository , caisseRepository);
            
            rd.addFlashAttribute("toastMessage", "Paiement effectué avec succès !");
            rd.addFlashAttribute("toastType", "success");
        } catch (Exception e) {
            rd.addFlashAttribute("toastMessage", e.getMessage());
            rd.addFlashAttribute("toastType", "error");
        }
        return "redirect:/tickets/fiche/" + ticketStrId;
    }
}
