<section class="section" th:fragment="page">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="card-title">Saisie Commande</h4>
            <div>
                <button type="button" class="btn btn-sm btn-success" id="addRowBtn">Ajouter ligne</button>
                <button type="button" class="btn btn-sm btn-danger" id="deleteSelectedBtn">Supprimer sélection</button>
            </div>
        </div>

        <div class="card-body">
            <form th:action="@{/commandes/saisie}" method="post">
                <input type="hidden" name="idSociete" th:value="${societe.idSociete}" />

                <div class="table-responsive">
                    <table class="table table-bordered" id="commandeTable">
                        <thead>
                            <tr>
                                <th style="width:40px"><input type="checkbox" id="selectAll"></th>
                                <th>Séance</th>
                                <th>Pub (Société)</th>
                                <th style="width:120px">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- starter row -->
                            <tr class="data-row">
                                <td class="text-center"><input type="checkbox" class="row-check"></td>
                                <td>
                                    <select class="form-select form-select-sm" name="seanceIds">
                                        <option value="">-- Sélectionner --</option>
                                        <option th:each="seance : ${seances}" th:value="${seance.idSeance}"
                                            th:text="|${seance.strId} - ${#temporals.format(seance.dateTimeDebut, 'yyyy-MM-dd HH:mm')}|">
                                        </option>

                                    </select>
                                </td>
                                <td>
                                    <select class="form-select form-select-sm" name="pubIds">
                                        <option value="">-- Sélectionner --</option>
                                        <option th:each="pub : ${pubs}" th:value="${pub.idPub}" th:text="${pub.desc}">
                                        </option>
                                    </select>
                                </td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-danger remove-row">Supprimer</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Enregistrer la commande</button>
                    <a th:href="@{/societes/liste}" class="btn btn-secondary">Annuler</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        (function () {
            const table = document.getElementById('commandeTable');
            const addRowBtn = document.getElementById('addRowBtn');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const selectAll = document.getElementById('selectAll');

            function bindRow(row) {
                row.querySelector('.remove-row').addEventListener('click', function () {
                    row.remove();
                });
            }

            // bind existing starter row
            document.querySelectorAll('#commandeTable tbody .data-row').forEach(bindRow);

            addRowBtn.addEventListener('click', function () {
                const tbody = table.querySelector('tbody');
                const prototype = tbody.querySelector('.data-row');
                const clone = prototype.cloneNode(true);
                // clear selects and checkbox
                clone.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
                clone.querySelector('.row-check').checked = false;
                tbody.appendChild(clone);
                bindRow(clone);
            });

            deleteSelectedBtn.addEventListener('click', function () {
                const rows = Array.from(table.querySelectorAll('tbody tr'));
                rows.forEach(r => {
                    const cb = r.querySelector('.row-check');
                    if (cb && cb.checked) {
                        r.remove();
                    }
                });
            });

            selectAll.addEventListener('change', function () {
                const checked = this.checked;
                document.querySelectorAll('.row-check').forEach(cb => cb.checked = checked);
            });

        })();
    </script>
</section>